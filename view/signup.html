{{define "signup"}} {{template "header"}}

<div class="signup-wrapper">
    <div class="signup-container">
        <h3>Signup Forum-X</h3>
        <form enctype="multipart/form-data" autocomplete="on" onsubmit="event.preventDefault()">
            <input type="text" id="fullname" name="fullname" placeholder="Full Name" required>
            <input type="text" id="username" name="username" placeholder="Username" required>
            <input id="email" type="email" name="email" placeholder="Email" required>
            <input type="number" id="age" name="age" placeholder="Age" min="16" max="80">
            <input type="hidden" id="authType" name="authType" value="default">

            <select id="sex" name="sex">
                <option value="male">Male</option>
                <option value="female">Female</option>
            </select>

            <select name="city" id="city">
                <option value="Almaty">Almaty</option>
                <option value="Astana">Astana</option>
                <option value="Karaganda">Karaganda</option>
                <option value="Shymkent">Shymkent</option>
                <option value="Aktau">Aktau</option>
                <option value="Atyrau">Atyrau</option>
                <option value="Taraz">Taraz</option>
                <option value="Kokshetau">Kokshetau</option>
                <option value="Semey">Semey</option>
                <option value="Uralsk">Uralsk</option>
                <option value="Pavlodar">Pavlodar</option>
                <option value="Petropavlsk">Petropavlsk</option>
                <option value="Kyzyldorda">Kyzyldorda</option>
                <option value="Ust-kamenogorsk">Ust-kamenogorsk</option>
            </select>

            <input id="password1" name="password" type="password" placeholder="Password" required>
            <input id="password2" name="password" type="password" placeholder="Repeat password" required>

            <label for="image">Image:
                <input name="image" id="image" type="file" accept="image/*" />
            </label>
            <input onclick="signup()" type="submit" value="Register ">
        </form>
        <span>If you are logged in, then log in to me <a style="color: gold; " href="/signin">Signin</a> </span>
        <br />
        <span id="notify"> </span>
    </div>
</div>

<script>

    const showNotify = (msg) => {
        if (msg != "success") {
            console.log(msg, "msg")
            let ns = document.getElementById('notify')
            ns.innerText = msg
        } else {
            console.log(msg, "norm signup")
            window.location.replace("https://forumx.herokuapp.com/signin")
        }
    }
    const getBase64 = (file) => new Promise(function (resolve, reject) {
        let reader = new FileReader();
        // console.log(reader.readAsBinaryString(file), "reader1")
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result)
        reader.onerror = (error) => reject('Error: ', error);
    })

    function signup() {

        let user = {
            image: null,
            email: '',
            username: '',
            age: 0,
            fullname: '',
            type: '',
            sex: '',
            password1: '',
            password2: '',
            city: ''
        };
        user.username = document.getElementById("username").value;
        user.fullname = document.getElementById("fullname").value;
        user.email = document.getElementById("email").value;
        user.age = document.getElementById("age").value;
        user.type = document.getElementById("authType").value;
        user.password1 = document.getElementById("password1").value;
        user.password2 = document.getElementById("password2").value;
        user.city = document.getElementById("city").value;
        user.sex = document.getElementById("sex").value;
        user.image = document.getElementById("image").files;
        
        var file = document.querySelector('input[type="file"]').files[0];
        //console.log(getBase64(file))
        let encoded;
        console.log(user.image,  user.image[0])
        getBase64(user.image[0])
        
            .then((result) => {
                encoded = result;
            })
            .catch(e => console.log(e))

        console.log(encoded, "enc", user.image[0])
        //   if (user.email != '' && user.password1 != '' && user.city != ''  && user.password2 != ''  && user.username != '' &&  user.fullname != ''  && user.sex != '') {

        console.log(user, "user client ", file)
        //async fetch query
        async function getUserAsync() {
            let response = await fetch('https://forumx.herokuapp.com/signup', {
                method: 'post',
                body: JSON.stringify(user),
            });
            let data = await response.json()
            return data;
        }
        getUserAsync()
            .then(data => showNotify(data));
    }
</script>
{{end}}